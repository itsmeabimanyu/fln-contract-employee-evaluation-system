{% extends 'layouts/base.html' %}
{% load static custom_filters %}
<!-- [ Main Content ] start -->
{% block content %}

<div class="tile mb-4">
    <div class="page-header">
        <form method="post" id="myForm">
        {% csrf_token %}
            <div class="row">
                <div class="col-lg-12">
                    <div class="mailbox-controls">
                    <h3 class="tile-title">{{ card_title }}</h3>
                    <div class="btn-group">
                       {{ btn_group|safe }}
                    </div>
                    </div>
                </div>
                {% if not dis_add_row %} 
                <div class="col-lg-12 mb-3">
                    <div class="d-flex justify-content-end">
                        <div class="input-group" style="max-width: 300px;">
                            <input type="number" id="rowCount" class="form-control" min="1">
                            <button class="btn btn-sm btn-secondary" type="button" id="addRows">
                                <i class="bi bi-plus-circle me-2"></i>Add Rows
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
                <div class="table-responsive">
                    <table id="add-row" class="table table-sm table-hover table-bordered" >
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="check-all" {% if not items %}disabled{% endif %}></th>
                                <th>#</th>
                                {% if fields %}
                                    {% for key, field in fields.items %}
                                        <th>{{ field }}</th>
                                    {% endfor %}
                                {% else %}
                                    {% for field in formset %}
                                        <th>{{ field.label }}</th>
                                    {% endfor %}
                                {% endif %}
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- ListView -->
                            {% for item in items %}
                            <tr>
                                <td><input type="checkbox" class="select" name="select" value="{{ item.id }}"></td>
                                <td class="clickable table-secondary">{{ forloop.counter }}</td>
                                {% if fields %}
                                    {% for field in fields %}
                                    <td>{{ item|get_field_value:field|upper|safe }}</td>
                                    {% endfor %}
                                {% else %}
                                    {% for field in formset %}
                                    <td>{{ item|get_field_value:field.name|upper|safe }}</td>
                                    {% endfor %}
                                {% endif %}
                                <td>
                                    <!-- <button type="button" class="btn btn-sm btn-secondary dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#act-{{ item.id }}">Options </button>
                                    <div id="act-{{ item.id }}" class="collapse mt-1"> -->
                                        {% for value in item.buttons_action %}
                                            {{ value|safe  }}
                                        {% endfor %}
                                    <!-- </div> -->
                                </td>
                            </tr>
                            {% endfor %}
                            <!-- End ListView -->

                            <!-- Form -->
                            {% if not btn_group %} <!-- cegah isi form via table "new form via btn_group" -->
                            <tr>
                                <td></td>
                                <td></td>
                                {% for field in formset %}
                                    <td>{{ field }}</td>
                                {% endfor %}
                                <td class="align-middle">
                                    <div class="bs-component">
                                        <div class="btn-group" role="group" aria-label="Basic example">
                                            <div class="btn-group" role="group" aria-label="Basic example">
                                                <button type="button" class="btn btn-sm btn-danger deleteRow" title="Delete"><i class="bi bi-trash3-fill"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </td> 
                            </tr>
                            {% endif %}
                            <!-- End Form -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tile-footer">
                <div class="row">
                    <div class="col-md-8 col-md-offset-3">
                        {% if not btn_group %}
                        <button class="btn btn-primary" name="action" value="save" type="submit"><i class="bi bi-check-circle-fill me-2"></i>Submit</button>&nbsp;&nbsp;&nbsp;<button class="btn btn-secondary" type="button" onclick="window.history.back();"><i class="bi bi-x-circle-fill me-2"></i>Cancel</button>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        {{ buttons_action|safe }}
                    </div>
                </div>
            </div>

            {% block delete_checked %}
                {% include 'includes/modal_delete_checked.html' %}
            {% endblock delete_checked %}
        </form>
    </div>
</div>

{% block modal %}
    {% include 'includes/modal.html' %}
{% endblock modal %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Checkbox Select All dan toggle tombol hapus
        const $checkAll = $('#check-all');
        const $checkboxes = $('.select');
        const $deleteButton = $('#delete-button');
        const $deleteModalButton = $('#delete-modal-button');
        const $form = $('#myForm');

        function disableRequiredFields() {
            $form.find('[required]').removeAttr('required');
        }
        $deleteModalButton.on('click', disableRequiredFields);

        function toggleButtonVisibility() {
            const anyChecked = $checkboxes.is(':checked') || $checkAll.is(':checked');
            if (!anyChecked) {
                $deleteButton.removeClass('btn-danger').addClass('btn-secondary disabled');
            } else {
                $deleteButton.removeClass('btn-secondary disabled').addClass('btn-danger');
            }
        }

        $checkAll.on('change', function() {
            $checkboxes.prop('checked', $(this).prop('checked'));
            toggleButtonVisibility();
        });

        $checkboxes.on('change', function() {
            if (!$(this).prop('checked')) {
                $checkAll.prop('checked', false);
            } else {
                const allChecked = $checkboxes.length === $checkboxes.filter(':checked').length;
                $checkAll.prop('checked', allChecked);
            }
            toggleButtonVisibility();
        });

        toggleButtonVisibility();

        // Fungsi Add Rows
        let rowIndex = $('#add-row tbody tr').length; // Hitung jumlah baris awal

        $('#addRows').on('click', function () {
            let rowCount = parseInt($('#rowCount').val()) || 1;

            if (isNaN(rowCount) || rowCount <= 0) {
                alert('Invalid input! Please enter a number greater than 0.');
                return;
            }

            let $templateRow = $('#add-row tbody tr:first');

            for (let i = 0; i < rowCount; i++) {
                let $newRow = $templateRow.clone();

                // Kosongkan input
                $newRow.find('input, select, textarea').each(function () {
                    if ($(this).is(':checkbox') || $(this).is(':radio')) {
                        // Uncheck checkbox/radio
                        $(this).prop('checked', false);
                    } else {
                        $(this).val('');
                    }
                });

                // Ubah ID dan for agar unik
                $newRow.find('[id]').each(function () {
                    let newId = $(this).attr('id') + '-' + rowIndex;
                    $(this).attr('id', newId);
                });

                $newRow.find('label[for]').each(function () {
                    let newFor = $(this).attr('for') + '-' + rowIndex;
                    $(this).attr('for', newFor);
                });

                $('#add-row tbody').prepend($newRow);
                rowIndex++;
            }

            $('#rowCount').val('');
            initDatepickers();
        });
    });
</script>

{% endblock content %}